(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();function J(){const e=document.getElementById("posing-canvas"),t=document.getElementById("ui-canvas"),i=document.getElementById("import-input"),o=document.getElementById("duration-input"),n=document.getElementById("duration-label"),s=document.getElementById("time-mode-toggle-btn"),a=document.getElementById("animate-btn"),r=document.getElementById("pause-btn"),l=document.getElementById("insert-keyframe-btn"),h=document.getElementById("mode-btn"),d=document.getElementById("ik-mode-btn"),u=document.getElementById("onion-btn"),f=document.getElementById("full-onion-skin-btn"),c=document.getElementById("motion-trail-step-input"),I=document.getElementById("export-btn"),m=document.getElementById("import-btn"),y=document.getElementById("onion-before-input"),g=document.getElementById("onion-after-input");if(!e||!t||!i||!o||!n||!s||!a||!r||!l||!h||!d||!u||!f||!c||!I||!m||!y||!g)throw new Error("Could not find all required DOM elements.");return{posingCanvas:e,uiCanvas:t,importInput:i,durationInput:o,durationLabel:n,timeModeToggleBtn:s,animateBtn:a,pauseBtn:r,insertKeyframeBtn:l,modeBtn:h,ikModeBtn:d,onionBtn:u,fullOnionSkinBtn:f,motionTrailStepInput:c,exportBtn:I,importBtn:m,onionBeforeInput:y,onionAfterInput:g}}function V(){return{isAnimating:!1,isPaused:!1,animationMode:"loop",animationRequestId:null,animationStartTime:null,timeElapsedBeforePause:0,animationTotalDuration:5e3,animationProgress:0,timeDisplayMode:"seconds",activeKeyframeIndexBeforeAnimation:null}}function z(){return{currentMousePos:null,hoveredThumbnailIndex:null,hoveredDeleteIconIndex:null,hoveredScrollLeft:!1,hoveredScrollRight:!1,hoveredGround:!1,hoveredVerticalGuide:!1,hoveredMarkerIndex:null,hoveredPlayhead:!1,hoveredJointKey:null,scrollOffset:0,dropTargetIndex:null}}function j(){return{draggedPointKey:null,isDraggingGround:!1,isDraggingVerticalGuide:!1,draggedMarkerIndex:null,isDraggingPlayhead:!1,draggedThumbnailIndex:null,draggedEndEffector:null}}function q(){return{isOnionModeEnabled:!1,onionSkinBefore:5,onionSkinAfter:5,isFullOnionSkinEnabled:!1,motionTrailResolution:1,onionTrailCanvas:null}}function $(){return{isIKModeEnabled:!1,draggedEndEffector:null}}function Y(e,t){return{stickFigurePose:JSON.parse(JSON.stringify(e.defaultPose)),keyframes:[],activeKeyframeIndex:null,groundY:t.GROUND_Y_POSITION,verticalGuideX:50,animation:V(),ui:z(),drag:j(),onion:q(),ik:$()}}function W(e){return{get stickFigurePose(){return e.stickFigurePose},set stickFigurePose(t){e.stickFigurePose=t},get keyframes(){return e.keyframes},set keyframes(t){e.keyframes=t},get activeKeyframeIndex(){return e.activeKeyframeIndex},set activeKeyframeIndex(t){e.activeKeyframeIndex=t},get groundY(){return e.groundY},set groundY(t){e.groundY=t},get verticalGuideX(){return e.verticalGuideX},set verticalGuideX(t){e.verticalGuideX=t},get isAnimating(){return e.animation.isAnimating},set isAnimating(t){e.animation.isAnimating=t},get isPaused(){return e.animation.isPaused},set isPaused(t){e.animation.isPaused=t},get animationMode(){return e.animation.animationMode},set animationMode(t){e.animation.animationMode=t},get animationRequestId(){return e.animation.animationRequestId},set animationRequestId(t){e.animation.animationRequestId=t},get animationStartTime(){return e.animation.animationStartTime},set animationStartTime(t){e.animation.animationStartTime=t},get timeElapsedBeforePause(){return e.animation.timeElapsedBeforePause},set timeElapsedBeforePause(t){e.animation.timeElapsedBeforePause=t},get animationTotalDuration(){return e.animation.animationTotalDuration},set animationTotalDuration(t){e.animation.animationTotalDuration=t},get animationProgress(){return e.animation.animationProgress},set animationProgress(t){e.animation.animationProgress=t},get timeDisplayMode(){return e.animation.timeDisplayMode},set timeDisplayMode(t){e.animation.timeDisplayMode=t},get activeKeyframeIndexBeforeAnimation(){return e.animation.activeKeyframeIndexBeforeAnimation},set activeKeyframeIndexBeforeAnimation(t){e.animation.activeKeyframeIndexBeforeAnimation=t},get currentMousePos(){return e.ui.currentMousePos},set currentMousePos(t){e.ui.currentMousePos=t},get hoveredThumbnailIndex(){return e.ui.hoveredThumbnailIndex},set hoveredThumbnailIndex(t){e.ui.hoveredThumbnailIndex=t},get hoveredDeleteIconIndex(){return e.ui.hoveredDeleteIconIndex},set hoveredDeleteIconIndex(t){e.ui.hoveredDeleteIconIndex=t},get hoveredScrollLeft(){return e.ui.hoveredScrollLeft},set hoveredScrollLeft(t){e.ui.hoveredScrollLeft=t},get hoveredScrollRight(){return e.ui.hoveredScrollRight},set hoveredScrollRight(t){e.ui.hoveredScrollRight=t},get hoveredGround(){return e.ui.hoveredGround},set hoveredGround(t){e.ui.hoveredGround=t},get hoveredVerticalGuide(){return e.ui.hoveredVerticalGuide},set hoveredVerticalGuide(t){e.ui.hoveredVerticalGuide=t},get hoveredMarkerIndex(){return e.ui.hoveredMarkerIndex},set hoveredMarkerIndex(t){e.ui.hoveredMarkerIndex=t},get hoveredPlayhead(){return e.ui.hoveredPlayhead},set hoveredPlayhead(t){e.ui.hoveredPlayhead=t},get hoveredJointKey(){return e.ui.hoveredJointKey},set hoveredJointKey(t){e.ui.hoveredJointKey=t},get scrollOffset(){return e.ui.scrollOffset},set scrollOffset(t){e.ui.scrollOffset=t},get dropTargetIndex(){return e.ui.dropTargetIndex},set dropTargetIndex(t){e.ui.dropTargetIndex=t},get draggedPointKey(){return e.drag.draggedPointKey},set draggedPointKey(t){e.drag.draggedPointKey=t},get isDraggingGround(){return e.drag.isDraggingGround},set isDraggingGround(t){e.drag.isDraggingGround=t},get isDraggingVerticalGuide(){return e.drag.isDraggingVerticalGuide},set isDraggingVerticalGuide(t){e.drag.isDraggingVerticalGuide=t},get draggedMarkerIndex(){return e.drag.draggedMarkerIndex},set draggedMarkerIndex(t){e.drag.draggedMarkerIndex=t},get isDraggingPlayhead(){return e.drag.isDraggingPlayhead},set isDraggingPlayhead(t){e.drag.isDraggingPlayhead=t},get draggedThumbnailIndex(){return e.drag.draggedThumbnailIndex},set draggedThumbnailIndex(t){e.drag.draggedThumbnailIndex=t},get isOnionModeEnabled(){return e.onion.isOnionModeEnabled},set isOnionModeEnabled(t){e.onion.isOnionModeEnabled=t},get onionSkinBefore(){return e.onion.onionSkinBefore},set onionSkinBefore(t){e.onion.onionSkinBefore=t},get onionSkinAfter(){return e.onion.onionSkinAfter},set onionSkinAfter(t){e.onion.onionSkinAfter=t},get isFullOnionSkinEnabled(){return e.onion.isFullOnionSkinEnabled},set isFullOnionSkinEnabled(t){e.onion.isFullOnionSkinEnabled=t},get motionTrailResolution(){return e.onion.motionTrailResolution},set motionTrailResolution(t){e.onion.motionTrailResolution=t},get onionTrailCanvas(){return e.onion.onionTrailCanvas},set onionTrailCanvas(t){e.onion.onionTrailCanvas=t},get isIKModeEnabled(){return e.ik.isIKModeEnabled},set isIKModeEnabled(t){e.ik.isIKModeEnabled=t},get draggedEndEffector(){return e.ik.draggedEndEffector},set draggedEndEffector(t){e.ik.draggedEndEffector=t}}}function X(e,t,i,o,n,s,a,r){e.save(),e.strokeStyle="rgba(255, 255, 255, 0.4)",e.lineWidth=1,e.setLineDash([4,4]),e.beginPath(),e.moveTo(0,t),e.lineTo(o,t),e.stroke(),e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke(),e.setLineDash([]),e.lineCap="butt",e.lineWidth=a?8:5,e.strokeStyle=a?"rgba(255, 255, 0, 1)":"rgba(255, 255, 255, 0.6)",e.beginPath(),e.moveTo(0,t),e.lineTo(s,t),e.stroke(),e.lineWidth=r?8:5,e.strokeStyle=r?"rgba(255, 255, 0, 1)":"rgba(255, 255, 255, 0.6)",e.beginPath(),e.moveTo(i,n-s),e.lineTo(i,n),e.stroke(),e.restore()}function K(e,t,i={}){e.strokeStyle=i.strokeStyle||"#FFFFFF",e.lineWidth=3,e.lineCap="round",e.beginPath(),e.arc(t.head.x,t.head.y,20,0,Math.PI*2),e.stroke(),e.beginPath(),e.moveTo(t.neck.x,t.neck.y),e.lineTo(t.neckBase.x,t.neckBase.y),e.lineTo(t.hip.x,t.hip.y),e.stroke(),e.beginPath(),e.moveTo(t.neckBase.x,t.neckBase.y),e.lineTo(t.leftElbow.x,t.leftElbow.y),e.lineTo(t.leftHand.x,t.leftHand.y),e.moveTo(t.neckBase.x,t.neckBase.y),e.lineTo(t.rightElbow.x,t.rightElbow.y),e.lineTo(t.rightHand.x,t.rightHand.y),e.stroke(),e.fillStyle=i.fillStyle||"#FFFFFF";const o=8;e.beginPath(),e.arc(t.leftHand.x,t.leftHand.y,o,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t.rightHand.x,t.rightHand.y,o,0,Math.PI*2),e.fill(),e.beginPath(),e.moveTo(t.hip.x,t.hip.y),e.lineTo(t.leftKnee.x,t.leftKnee.y),e.lineTo(t.leftFoot.x,t.leftFoot.y),e.moveTo(t.hip.x,t.hip.y),e.lineTo(t.rightKnee.x,t.rightKnee.y),e.lineTo(t.rightFoot.x,t.rightFoot.y),e.moveTo(t.leftFoot.x,t.leftFoot.y),e.lineTo(t.leftToe.x,t.leftToe.y),e.moveTo(t.rightFoot.x,t.rightFoot.y),e.lineTo(t.rightToe.x,t.rightToe.y),e.stroke()}function D(e,t,i,o=!1){if(!i)return null;for(const n in e){const s=e[n];if(Math.hypot(i.x-s.x,i.y-s.y)<t)if(o){if(["leftHand","rightHand","leftFoot","rightFoot","leftToe","rightToe"].includes(n))return n}else return n}return null}function Z(e,t,i,o,n=!1){if(!o)return;const s=t[o];n?(e.fillStyle="rgba(0, 255, 255, 0.4)",e.strokeStyle="rgba(0, 255, 255, 0.8)"):(e.fillStyle="rgba(255, 255, 0, 0.3)",e.strokeStyle="rgba(255, 255, 0, 0.5)"),e.lineWidth=2,e.beginPath(),e.arc(s.x,s.y,i,0,Math.PI*2),e.fill(),e.stroke()}function b(e,t,i,o){const n={hip:{...e.hip}},s=["hip"];for(;s.length>0;){const a=s.shift(),r=n[a],l=o[a]||[];for(const h of l){const d=e.angles[h],u=i[`${h}-${a}`];d!==void 0&&u!==void 0&&(n[h]={x:r.x+Math.cos(d)*u,y:r.y+Math.sin(d)*u},s.push(h))}}return n}function Q(e,t){const i={hip:{...e.hip},angles:{}};for(const o in t){const n=t[o],s=e[o],a=e[n],r=s.x-a.x,l=s.y-a.y;i.angles[o]=Math.atan2(l,r)}return i}function ee(e,t){const i=e/2,o=t/2,n={head:{x:i,y:o-80},neck:{x:i,y:o-60},neckBase:{x:i,y:o-40},hip:{x:i,y:o+20},leftElbow:{x:i-30,y:o-20},leftHand:{x:i-60,y:o+10},rightElbow:{x:i+30,y:o-20},rightHand:{x:i+60,y:o+10},leftKnee:{x:i-20,y:o+65},leftFoot:{x:i-30,y:o+110},leftToe:{x:i-50,y:o+110},rightKnee:{x:i+20,y:o+65},rightFoot:{x:i+30,y:o+110},rightToe:{x:i+50,y:o+110}},s={neckBase:"hip",neck:"neckBase",head:"neck",leftElbow:"neckBase",rightElbow:"neckBase",leftHand:"leftElbow",rightHand:"rightElbow",leftKnee:"hip",rightKnee:"hip",leftFoot:"leftKnee",rightFoot:"rightKnee",leftToe:"leftFoot",rightToe:"rightFoot"},a={};for(const h in s){const d=s[h];a[d]||(a[d]=[]),a[d].push(h)}const r={};for(const h in s){const d=h,u=s[d];r[`${d}-${u}`]=Math.hypot(n[d].x-n[u].x,n[d].y-n[u].y)}const l=Q(n,s);return{hierarchy:s,children:a,boneLengths:r,defaultPose:l,canvasWidth:e,posingAreaHeight:t}}function te(e){return{x:e.x+e.width-18-3,y:e.y+3,width:18,height:18}}function R(e,t){const o=t.x+e.time*t.width,n=t.y+t.height/2;return{x:o-16/2,y:n-16/2,width:16,height:16}}function ie(e,t,i,o,n,s,a,r=!1){const l=s||r;e.fillStyle=l?"#444":o?"#888":"#666",e.fillRect(t.x,t.y,t.width,t.height);const h=a||r;e.fillStyle=h?"#444":n?"#888":"#666",e.fillRect(i.x,i.y,i.width,i.height),e.lineWidth=3,e.lineCap="round",e.lineJoin="round";const d=t.width*.2,u=t.height*.25;e.strokeStyle=l?"#666":"#FFF",e.beginPath(),e.moveTo(t.x+t.width/2+d,t.y+t.height/2-u),e.lineTo(t.x+t.width/2-d,t.y+t.height/2),e.lineTo(t.x+t.width/2+d,t.y+t.height/2+u),e.stroke(),e.strokeStyle=h?"#666":"#FFF",e.beginPath(),e.moveTo(i.x+i.width/2-d,i.y+i.height/2-u),e.lineTo(i.x+i.width/2+d,i.y+i.height/2),e.lineTo(i.x+i.width/2-d,i.y+i.height/2+u),e.stroke()}function ne(e,t,i,o,n,s,a,r,l,h,d,u,f,c,I,m,y){if(c!==null&&f!==null){const g=c-a;if(g>=0&&g<=t.length){let M;if(g<t.length)M=t[g].x-I/2;else{const p=t[t.length-1];M=p.x+p.width+I/2}i.length>0&&t.length>0&&(e.save(),e.fillStyle="#f0ad4e",e.fillRect(M-1.5,t[0].y,3,t[0].height),e.restore())}}t.forEach((g,M)=>{const p=a+M;if(!(p>=i.length)){if(e.save(),p===f&&(e.globalAlpha=.4),e.fillStyle="#000",e.fillRect(g.x,g.y,g.width,g.height),e.strokeStyle="#555",p===n?(e.strokeStyle="#f0ad4e",e.shadowColor="#f0ad4e",e.shadowBlur=10):p===s&&!h&&(e.strokeStyle="#777"),e.lineWidth=2,e.strokeRect(g.x,g.y,g.width,g.height),e.shadowBlur=0,i[p]){const N=p===n&&n!==null?o:i[p].pose,U=b(N,d.hierarchy,d.boneLengths,d.children),B=e;B.save(),B.translate(g.x,g.y),B.scale(g.width/r,g.height/l),K(B,U),B.restore(),e.fillStyle="rgba(255, 255, 255, 0.9)",e.font="bold 12px sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(String(p+1),g.x+4,g.y+4);const F=i[p];let w="";y==="seconds"?w=`${(F.time*m/1e3).toFixed(1)}s`:w=`${Math.round(F.time*(m/1e3)*60)}f`,e.fillStyle="rgba(255, 255, 255, 0.8)",e.font="11px sans-serif",e.textAlign="right",e.textBaseline="bottom",e.fillText(w,g.x+g.width-4,g.y+g.height-4);const v=te(g),G=p===u&&!h;e.save(),e.fillStyle=G?"#e63946":"rgba(200, 50, 50, 0.8)",e.strokeStyle="#FFFFFF",e.lineWidth=1.5,e.beginPath(),e.roundRect(v.x,v.y,v.width,v.height,[4]),e.fill();const P=5;e.beginPath(),e.moveTo(v.x+P,v.y+P),e.lineTo(v.x+v.width-P,v.y+v.height-P),e.moveTo(v.x+v.width-P,v.y+P),e.lineTo(v.x+P,v.y+v.height-P),e.stroke(),e.restore()}e.restore()}})}function oe(e,t,i){const{keyframes:o,activeKeyframeIndex:n,hoveredMarkerIndex:s,isAnimating:a,animationProgress:r,isPaused:l,hoveredPlayhead:h}=i;if(e.fillStyle="#111",e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(t.x,t.y,t.width,t.height),o.forEach((d,u)=>{const f=R(d,t),c=u===s&&!a,I=u===n,m=u>0&&u<o.length-1;e.save(),e.translate(f.x+f.width/2,f.y+f.height/2),e.rotate(Math.PI/4);let y="#888";m||(y="#555"),I&&(y="#f0ad4e"),c&&m&&(y="#ec9b2e"),e.fillStyle=y,e.strokeStyle="#FFF",e.lineWidth=I||c?2:1,e.beginPath(),e.rect(-f.width/2,-f.height/2,f.width,f.height),e.fill(),e.stroke(),e.restore()}),o.length>0){const d=t.x+r*t.width,u=!a||l,f=u&&h;e.save(),e.strokeStyle=f?"#64faff":"#3498db",e.lineWidth=f?4:2,e.beginPath(),e.moveTo(d,t.y-4),e.lineTo(d,t.y+t.height+4),e.stroke(),u&&(e.fillStyle=f?"#64faff":"#3498db",e.beginPath(),e.arc(d,t.y+t.height/2,f?8:6,0,Math.PI*2),e.fill()),e.restore()}}function se(e,t,i){const s={x:50,y:5,width:e-100,height:12},a=100,r=75,l=5+s.height+5,h=10,d=5,u=40,f=d*a+(d-1)*h,c=(e-f)/2,I=Array.from({length:d},(M,p)=>({x:c+p*(a+h),y:l,width:a,height:r})),m=40,y={x:c-m-h,y:l,width:m,height:r},g={x:c+f+h,y:l,width:m,height:r};return{UI_PANEL_HEIGHT:t,POSING_AREA_HEIGHT:i,GROUND_Y_POSITION:396,TIMELINE_RECT:s,THUMBNAIL_RECTS:I,VISIBLE_THUMBNAILS:d,SCROLL_LEFT_BUTTON_RECT:y,SCROLL_RIGHT_BUTTON_RECT:g,GUIDE_GRABBER_SIZE:u,THUMBNAIL_GAP:h}}function ae(e,t,i,o,n,s){e.clearRect(0,0,t,i),n.keyframes.length>0&&oe(e,o.TIMELINE_RECT,n),ne(e,o.THUMBNAIL_RECTS,n.keyframes,n.stickFigurePose,n.activeKeyframeIndex,n.hoveredThumbnailIndex,n.scrollOffset,s.canvasWidth,s.posingAreaHeight,n.isAnimating,s,n.hoveredDeleteIconIndex,n.draggedThumbnailIndex,n.dropTargetIndex,o.THUMBNAIL_GAP,n.animationTotalDuration,n.timeDisplayMode);const a=n.scrollOffset===0,r=n.scrollOffset>=n.keyframes.length-o.VISIBLE_THUMBNAILS;ie(e,o.SCROLL_LEFT_BUTTON_RECT,o.SCROLL_RIGHT_BUTTON_RECT,n.hoveredScrollLeft,n.hoveredScrollRight,a,r,n.isAnimating)}function re(e,t,i,o,n){if(e.clearRect(0,0,t.width,t.height),i.activeKeyframeIndex!==null&&(e.save(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.font="16px sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(`Keyframe: ${i.activeKeyframeIndex+1} / ${i.keyframes.length}`,15,15),e.restore()),X(e,i.groundY,i.verticalGuideX,t.width,o.POSING_AREA_HEIGHT,o.GUIDE_GRABBER_SIZE,i.hoveredGround,i.hoveredVerticalGuide),i.isAnimating&&i.onionTrailCanvas&&e.drawImage(i.onionTrailCanvas,0,0),i.isOnionModeEnabled&&i.activeKeyframeIndex!==null){const r=i.activeKeyframeIndex,l=.4,h=(f,c,I)=>{var m;if(f>=0&&f<i.keyframes.length){const y=(m=i.keyframes[f])==null?void 0:m.pose;if(y&&y.hip&&y.angles){const g=l/c;if(g>.05){const M=b(y,n.hierarchy,n.boneLengths,n.children),p=`rgba(${I}, ${g})`;K(e,M,{strokeStyle:p,fillStyle:p})}}}},d="255, 87, 34",u="33, 150, 243";for(let f=1;f<=i.onionSkinBefore;f++)h(r-f,f,d);for(let f=1;f<=i.onionSkinAfter;f++)h(r+f,f,u)}const s=b(i.stickFigurePose,n.hierarchy,n.boneLengths,n.children);K(e,s),!i.isAnimating&&!i.draggedMarkerIndex&&Z(e,s,15,i.hoveredJointKey,i.isIKModeEnabled)}function le(e,t,i,o,n){e.clearRect(0,0,t.width,t.height),ae(e,t.width,t.height,o,i,n)}function de(e,t,i){let o="default",n="default";i.isAnimating&&!i.isPaused||(i.isDraggingGround?o="ns-resize":i.isDraggingVerticalGuide?o="ew-resize":i.hoveredJointKey?o="pointer":i.hoveredGround?o="ns-resize":i.hoveredVerticalGuide&&(o="ew-resize")),i.draggedThumbnailIndex!==null||i.isDraggingPlayhead||i.draggedMarkerIndex!==null?n="grabbing":i.hoveredThumbnailIndex!==null&&i.hoveredDeleteIconIndex===null?n="grab":i.hoveredPlayhead?n="ew-resize":i.hoveredMarkerIndex!==null?n="grab":(i.hoveredDeleteIconIndex!==null||i.hoveredScrollLeft||i.hoveredScrollRight)&&(n="pointer"),e.style.cursor=o,t.style.cursor=n}function x(e,t,i){return e*(1-i)+t*i}function he(e,t,i){const o=t-e;return Math.abs(o)>Math.PI&&(o>0?e+=2*Math.PI:t+=2*Math.PI),x(e,t,i)}function ue(e,t,i){const o={};for(const s in e.angles)t.angles[s]!==void 0?o[s]=he(e.angles[s],t.angles[s],i):o[s]=e.angles[s];return{hip:{x:x(e.hip.x,t.hip.x,i),y:x(e.hip.y,t.hip.y,i)},angles:o}}function _(e,t){if(t.length===0)return null;if(t.length===1)return JSON.parse(JSON.stringify(t[0].pose));let i=-1;for(let o=0;o<t.length-1;o++)if(e>=t[o].time&&e<=t[o+1].time){i=o;break}if(i===-1)return e>=1?JSON.parse(JSON.stringify(t[t.length-1].pose)):JSON.parse(JSON.stringify(t[0].pose));{const o=i+1,n=t[i],s=t[o],a=s.time-n.time,r=e-n.time,l=a===0?1:Math.min(1,r/a);return ue(n.pose,s.pose,l)}}function H(e){if(e.keyframes.length===0)return;const t=_(e.animationProgress,e.keyframes);t&&(e.stickFigurePose=t)}function fe(e,t,i,o){if(!e.isFullOnionSkinEnabled||e.keyframes.length<2){e.onionTrailCanvas=null;return}const n=document.createElement("canvas");n.width=i.width,n.height=o.POSING_AREA_HEIGHT;const s=n.getContext("2d");if(!s){e.onionTrailCanvas=null;return}s.clearRect(0,0,n.width,n.height);const a=Math.floor(e.animationTotalDuration/1e3*60);if(a<2){e.onionTrailCanvas=null;return}const r=e.motionTrailResolution,l=Math.floor(a/r);if(l<=0){e.onionTrailCanvas=null;return}const d=`rgba(200, 225, 255, ${Math.max(.01,Math.min(.25,15/l))})`;for(let u=0;u<a;u+=r){const f=u/(a-1),c=_(f,e.keyframes);if(c){const I=b(c,t.hierarchy,t.boneLengths,t.children);K(s,I,{strokeStyle:d,fillStyle:d})}}e.onionTrailCanvas=n}function L(e,t,i,o){if(!t.isAnimating||t.animationStartTime===null||t.keyframes.length<2)return;const n=t.animationMode==="ping-pong"?t.animationTotalDuration*2:t.animationTotalDuration,s=(e-t.animationStartTime)%n;let a;t.animationMode==="ping-pong"&&s>t.animationTotalDuration?a=(t.animationTotalDuration-(s-t.animationTotalDuration))/t.animationTotalDuration:a=s/t.animationTotalDuration,t.animationProgress=a,H(t),i(),o(),t.isAnimating&&(t.animationRequestId=requestAnimationFrame(r=>L(r,t,i,o)))}function ge(e,t,i,o,n,s,a){e.keyframes.length<2||(fe(e,n,a,s),e.isAnimating=!0,e.isPaused=!1,e.timeElapsedBeforePause=0,e.animationStartTime=performance.now(),e.activeKeyframeIndexBeforeAnimation=e.activeKeyframeIndex,e.activeKeyframeIndex=null,t(),e.animationRequestId=requestAnimationFrame(r=>L(r,e,i,o)))}function me(e,t){e.animationRequestId&&cancelAnimationFrame(e.animationRequestId),e.animationRequestId=null,e.isAnimating=!1,e.isPaused=!1,e.onionTrailCanvas=null,e.activeKeyframeIndex=e.activeKeyframeIndexBeforeAnimation,e.activeKeyframeIndex!==null&&e.keyframes[e.activeKeyframeIndex]?(e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[e.activeKeyframeIndex].pose)),e.animationProgress=e.keyframes[e.activeKeyframeIndex].time):e.keyframes.length>0?(e.activeKeyframeIndex=0,e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[0].pose)),e.animationProgress=e.keyframes[0].time):e.animationProgress=0,t()}function ce(e,t){!e.isAnimating||e.isPaused||(e.animationRequestId&&cancelAnimationFrame(e.animationRequestId),e.animationRequestId=null,e.isPaused=!0,e.animationStartTime&&(e.timeElapsedBeforePause=performance.now()-e.animationStartTime),t())}function ye(e,t,i,o){!e.isAnimating||!e.isPaused||(e.isPaused=!1,e.animationStartTime&&(e.animationStartTime=performance.now()-e.timeElapsedBeforePause),t(),e.animationRequestId=requestAnimationFrame(n=>L(n,e,i,o)))}function S(e){e.activeKeyframeIndex!==null&&e.keyframes[e.activeKeyframeIndex]&&(e.keyframes[e.activeKeyframeIndex].pose=JSON.parse(JSON.stringify(e.stickFigurePose)))}function Ie(e,t){S(e);let i;e.keyframes.length===0?i=0:e.keyframes.length===1?i=1:i=e.animationProgress,e.keyframes.sort((a,r)=>a.time-r.time);const o=e.keyframes.findIndex(a=>a.time===i);if(o!==-1){const a=e.keyframes[o+1];a?i=i+(a.time-i)/2:i=1}const n={pose:JSON.parse(JSON.stringify(e.stickFigurePose)),time:i};if(e.keyframes.length>=1&&i>=1){const a=e.animationTotalDuration,r=a+1e3;if(e.animationTotalDuration=r,r>0)for(const l of e.keyframes)l.time=l.time*a/r;n.time=1}e.keyframes.push(n),e.keyframes.sort((a,r)=>a.time-r.time);const s=e.keyframes.indexOf(n);e.activeKeyframeIndex=s,e.animationProgress=n.time,s<e.scrollOffset?e.scrollOffset=s:s>=e.scrollOffset+t.VISIBLE_THUMBNAILS&&(e.scrollOffset=s-t.VISIBLE_THUMBNAILS+1)}function pe(e,t,i,o){S(e);const n=t===e.keyframes.length-1,s=e.animationTotalDuration;if(e.activeKeyframeIndex===t&&(e.activeKeyframeIndex=null,e.stickFigurePose=JSON.parse(JSON.stringify(i)),e.animationProgress=0,e.isOnionModeEnabled=!1),e.keyframes.splice(t,1),e.activeKeyframeIndex!==null&&e.activeKeyframeIndex>t&&e.activeKeyframeIndex--,e.keyframes.length===0)e.animationTotalDuration=5e3;else if(e.keyframes.length===1)e.keyframes[0].time=0;else if(n){const r=e.keyframes[e.keyframes.length-1].time*s;if(r>0&&s>0){e.animationTotalDuration=r;for(const l of e.keyframes)l.time=l.time*s/r}else e.keyframes.forEach(l=>l.time=0)}e.hoveredDeleteIconIndex=null,e.scrollOffset=Math.max(0,Math.min(e.scrollOffset,e.keyframes.length-o.VISIBLE_THUMBNAILS))}function ve(e,t,i){const o={pose:JSON.parse(JSON.stringify(t)),time:i};return e.keyframes.push(o),e.keyframes.sort((n,s)=>n.time-s.time),e.keyframes.indexOf(o)}function A(e,t){const i=e.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}function T(e,t){return e.x>t.x&&e.x<t.x+t.width&&e.y>t.y&&e.y<t.y+t.height}function Te(e){if(e.length===0){console.warn("No keyframes to export.");return}const t={version:"1.2.0",format:"stick-figure-animation",exportedAt:new Date().toISOString(),keyframes:e,metadata:{totalKeyframes:e.length,duration:e.length>1?e[e.length-1].time-e[0].time:0,hasIKSupport:!0}},i=JSON.stringify(t,null,2),o=new Blob([i],{type:"application/json"}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download="stick-figure-animation.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function O(e){e.angles.neck!==void 0&&e.angles.neckBase===void 0&&(e.angles.neckBase=e.angles.neck,e.angles.neck=-Math.PI/2);const t={neckBase:Math.PI/2,neck:Math.PI/2,head:Math.PI/2,leftElbow:-Math.PI/4,rightElbow:Math.PI/4,leftHand:-Math.PI/6,rightHand:Math.PI/6,leftKnee:Math.PI/6,rightKnee:Math.PI/6,leftFoot:0,rightFoot:0,leftToe:Math.PI,rightToe:0};for(const[i,o]of Object.entries(t))e.angles[i]===void 0&&(e.angles[i]=o);return e}function Ee(e){return new Promise((t,i)=>{const o=new FileReader;o.onload=n=>{var s;try{const a=(s=n.target)==null?void 0:s.result;if(typeof a!="string")throw new Error("Failed to read file.");const r=JSON.parse(a);let l=[];if(r.version&&r.format==="stick-figure-animation"&&r.keyframes){console.log(`Loading animation file version ${r.version}`);const h=r.version;if((h==="1.0.0"||h==="0.0.0"||h==="1.1.0")&&console.log("Converting from older version to v1.2.0 format (adding neckBase joint)"),Array.isArray(r.keyframes))l=r.keyframes.map(d=>({...d,pose:O(d.pose)}));else throw new Error("Invalid versioned keyframe file: keyframes array missing.")}else if(Array.isArray(r)){if(r.length===0){t([]);return}if(r[0].pose!==void 0&&typeof r[0].time=="number")console.log("Loading legacy new format (array of Keyframes)"),l=r.map(h=>({...h,pose:O(h.pose)}));else if(r[0].hip!==void 0&&r[0].angles!==void 0){console.log("Loading legacy old format (array of StickFigurePose)");const h=r.length;l=r.map((d,u)=>({pose:O(d),time:h<=1?0:u/(h-1)}))}else throw new Error("Unrecognized keyframe file format.")}else throw new Error("Invalid keyframe file: not a valid format.");if(l.some(h=>{var d,u,f;return typeof((u=(d=h.pose)==null?void 0:d.hip)==null?void 0:u.x)!="number"||typeof((f=h.pose)==null?void 0:f.angles)!="object"}))throw new Error("Invalid keyframe file format.");t(l)}catch(a){console.error("Error loading keyframes:",a),i(a)}},o.onerror=()=>{i(new Error("Error reading file."))},o.readAsText(e)})}class ke{constructor(t,i,o,n,s,a,r,l){this.dom=t,this.state=i,this.updateUI=o,this.redrawPosingCanvas=n,this.redrawUICanvas=s,this.kinematics=a,this.layout=r,this.posingCanvas=l}setupButtonHandlers(){this.setupAnimationButtons(),this.setupKeyframeButtons(),this.setupModeButtons(),this.setupImportExportButtons(),this.setupTimeDisplayButtons()}setupAnimationButtons(){this.dom.animateBtn.addEventListener("click",()=>{this.state.isAnimating?me(this.state,this.updateUI):this.state.keyframes.length>=2&&(S(this.state),ge(this.state,this.updateUI,this.redrawPosingCanvas,this.redrawUICanvas,this.kinematics,this.layout,this.posingCanvas))}),this.dom.pauseBtn.addEventListener("click",()=>{this.state.isAnimating&&(this.state.isPaused?ye(this.state,this.updateUI,this.redrawPosingCanvas,this.redrawUICanvas):ce(this.state,this.updateUI))})}setupKeyframeButtons(){this.dom.insertKeyframeBtn.addEventListener("click",()=>{if(this.dom.insertKeyframeBtn.disabled)return;const t=ve(this.state,this.state.stickFigurePose,this.state.animationProgress);this.state.animationRequestId&&cancelAnimationFrame(this.state.animationRequestId),this.state.animationRequestId=null,this.state.isAnimating=!1,this.state.isPaused=!1,this.state.activeKeyframeIndex=t,this.state.activeKeyframeIndex<this.state.scrollOffset?this.state.scrollOffset=this.state.activeKeyframeIndex:this.state.activeKeyframeIndex>=this.state.scrollOffset+this.layout.VISIBLE_THUMBNAILS&&(this.state.scrollOffset=this.state.activeKeyframeIndex-this.layout.VISIBLE_THUMBNAILS+1),this.updateUI()})}setupModeButtons(){this.dom.modeBtn.addEventListener("click",()=>{this.state.keyframes.length<2||(this.state.animationMode=this.state.animationMode==="loop"?"ping-pong":"loop",this.updateUI())}),this.dom.ikModeBtn.addEventListener("click",()=>{this.state.isAnimating||(this.state.isIKModeEnabled=!this.state.isIKModeEnabled,this.state.draggedEndEffector=null,this.updateUI())}),this.dom.onionBtn.addEventListener("click",()=>{this.state.isAnimating||this.state.activeKeyframeIndex===null||(this.state.isOnionModeEnabled=!this.state.isOnionModeEnabled,this.updateUI())}),this.dom.fullOnionSkinBtn.addEventListener("click",()=>{this.dom.fullOnionSkinBtn.disabled||(this.state.isFullOnionSkinEnabled=!this.state.isFullOnionSkinEnabled,this.updateUI())})}setupImportExportButtons(){this.dom.exportBtn.addEventListener("click",()=>{this.state.isAnimating||this.state.keyframes.length===0||(S(this.state),Te(this.state.keyframes))}),this.dom.importBtn.addEventListener("click",()=>{this.state.isAnimating||this.dom.importInput.click()}),this.dom.importInput.addEventListener("change",async t=>{var o;const i=(o=t.target.files)==null?void 0:o[0];if(i)try{S(this.state);const n=await Ee(i);this.state.keyframes=n,this.state.scrollOffset=0,this.state.keyframes.length>0?(this.state.activeKeyframeIndex=0,this.state.stickFigurePose=JSON.parse(JSON.stringify(this.state.keyframes[0].pose)),this.state.animationProgress=this.state.keyframes[0].time):(this.state.activeKeyframeIndex=null,this.state.stickFigurePose=JSON.parse(JSON.stringify(this.kinematics.defaultPose)),this.state.animationProgress=0),this.state.isOnionModeEnabled=!1,this.updateUI()}catch{alert("Failed to load keyframes. Please check the file format.")}t.target.value=""})}setupTimeDisplayButtons(){this.dom.timeModeToggleBtn.addEventListener("click",()=>{this.state.isAnimating||(this.state.timeDisplayMode=this.state.timeDisplayMode==="seconds"?"frames":"seconds",this.updateUI())}),this.dom.durationInput.addEventListener("change",()=>{if(this.state.timeDisplayMode==="seconds"){const t=parseFloat(this.dom.durationInput.value);!isNaN(t)&&t>0?this.state.animationTotalDuration=t*1e3:alert("Invalid duration. Please enter a positive number.")}else{const t=parseInt(this.dom.durationInput.value,10);!isNaN(t)&&t>0?this.state.animationTotalDuration=t/60*1e3:alert("Invalid duration. Please enter a positive integer for frames.")}this.updateUI()}),this.dom.motionTrailStepInput.addEventListener("change",()=>{const t=parseInt(this.dom.motionTrailStepInput.value,10);!isNaN(t)&&t>=1?this.state.motionTrailResolution=t:this.dom.motionTrailStepInput.value=this.state.motionTrailResolution.toString()}),this.dom.onionBeforeInput.addEventListener("change",()=>{const t=parseInt(this.dom.onionBeforeInput.value,10);!isNaN(t)&&t>=0?(this.state.onionSkinBefore=t,this.state.isOnionModeEnabled&&this.updateUI()):this.dom.onionBeforeInput.value=this.state.onionSkinBefore.toString()}),this.dom.onionAfterInput.addEventListener("change",()=>{const t=parseInt(this.dom.onionAfterInput.value,10);!isNaN(t)&&t>=0?(this.state.onionSkinAfter=t,this.state.isOnionModeEnabled&&this.updateUI()):this.dom.onionAfterInput.value=this.state.onionSkinAfter.toString()})}}function Se(e,t,i,o){const n=e.x-t.x,s=e.y-t.y,a=Math.hypot(n,s),r=Math.max(1e-6,Math.min(a,i+o-1e-6)),l=Math.acos((i*i+r*r-o*o)/(2*i*r)),h=Math.acos((i*i+o*o-r*r)/(2*i*o)),u=Math.atan2(s,n)-l,f=u+(Math.PI-h);return[u,f]}function Me(e,t,i,o){const n=JSON.parse(JSON.stringify(i)),s=b(i,o.hierarchy,o.boneLengths,o.children),r={leftHand:{base:"neckBase",joints:["leftElbow","leftHand"]},rightHand:{base:"neckBase",joints:["rightElbow","rightHand"]},leftFoot:{base:"hip",joints:["leftKnee","leftFoot"]},rightFoot:{base:"hip",joints:["rightKnee","rightFoot"]},leftToe:{base:"leftFoot",joints:["leftToe"]},rightToe:{base:"rightFoot",joints:["rightToe"]}}[t];if(!r)return null;const l=s[r.base];if(!l)return null;if(r.joints.length===1){const h=r.joints[0];if(o.boneLengths[`${h}-${r.base}`]!==void 0){const u=e.x-l.x,f=e.y-l.y;n.angles[h]=Math.atan2(f,u)}}else if(r.joints.length===2){const[h,d]=r.joints,u=o.boneLengths[`${h}-${r.base}`],f=o.boneLengths[`${d}-${h}`];if(u!==void 0&&f!==void 0){const c=Se(e,l,u,f);c&&(n.angles[h]=c[0],n.angles[d]=c[1])}}return n}function Pe(e){return["leftHand","rightHand","leftFoot","rightFoot","leftToe","rightToe"].includes(e)}class be{constructor(t,i,o,n,s,a,r){this.dom=t,this.state=i,this.layout=o,this.kinematics=n,this.updateUI=s,this.redrawPosingCanvas=a,this.redrawUICanvas=r,this.grabRadius=15,this.GUIDE_GRAB_BUFFER=10}setupMouseHandlers(){this.setupPosingCanvasMouseHandlers(),this.setupUICanvasMouseHandlers(),this.setupGlobalMouseHandlers(),this.setupKeyboardHandlers()}setupPosingCanvasMouseHandlers(){const{posingCanvas:t}=this.dom,{hierarchy:i,boneLengths:o,children:n}=this.kinematics;t.addEventListener("mousedown",s=>{const a=A(t,s);if(this.state.isAnimating&&!this.state.isPaused)return;const r={x:0,y:this.state.groundY-this.GUIDE_GRAB_BUFFER,width:this.layout.GUIDE_GRABBER_SIZE,height:this.GUIDE_GRAB_BUFFER*2};if(T(a,r)&&a.y<this.layout.POSING_AREA_HEIGHT){this.state.isDraggingGround=!0;return}const l={x:this.state.verticalGuideX-this.GUIDE_GRAB_BUFFER,y:this.layout.POSING_AREA_HEIGHT-this.layout.GUIDE_GRABBER_SIZE,width:this.GUIDE_GRAB_BUFFER*2,height:this.layout.GUIDE_GRABBER_SIZE};if(T(a,l)&&a.y<this.layout.POSING_AREA_HEIGHT){this.state.isDraggingVerticalGuide=!0;return}const h=b(this.state.stickFigurePose,i,o,n),d=D(h,this.grabRadius,a,this.state.isIKModeEnabled);d?(this.state.activeKeyframeIndex===null&&(this.addKeyframe(),this.updateUI()),this.state.isIKModeEnabled&&Pe(d)?this.state.draggedEndEffector=d:this.state.draggedPointKey=d):a.y<this.layout.POSING_AREA_HEIGHT&&(this.addKeyframe(),this.updateUI())}),t.addEventListener("mousemove",s=>{const a=A(t,s);if(this.state.currentMousePos=a,this.state.isDraggingGround){this.state.groundY=Math.max(0,Math.min(a.y,this.layout.POSING_AREA_HEIGHT)),this.redrawPosingCanvas();return}if(this.state.isDraggingVerticalGuide){this.state.verticalGuideX=Math.max(0,Math.min(a.x,t.width)),this.redrawPosingCanvas();return}if(this.state.draggedPointKey&&this.state.activeKeyframeIndex!==null){if(this.state.draggedPointKey==="hip")this.state.stickFigurePose.hip=a;else{const r=i[this.state.draggedPointKey],h=b(this.state.stickFigurePose,i,o,n)[r],d=Math.atan2(a.y-h.y,a.x-h.x);this.state.stickFigurePose.angles[this.state.draggedPointKey]=d}this.updateUI()}else if(this.state.draggedEndEffector&&this.state.activeKeyframeIndex!==null){const r=Me(a,this.state.draggedEndEffector,this.state.stickFigurePose,this.kinematics);r&&(this.state.stickFigurePose=r),this.updateUI()}else{const r=b(this.state.stickFigurePose,i,o,n);this.state.hoveredJointKey=D(r,this.grabRadius,a,this.state.isIKModeEnabled);const l={x:0,y:this.state.groundY-this.GUIDE_GRAB_BUFFER,width:this.layout.GUIDE_GRABBER_SIZE,height:this.GUIDE_GRAB_BUFFER*2};this.state.hoveredGround=T(a,l)&&a.y<this.layout.POSING_AREA_HEIGHT;const h={x:this.state.verticalGuideX-this.GUIDE_GRAB_BUFFER,y:this.layout.POSING_AREA_HEIGHT-this.layout.GUIDE_GRABBER_SIZE,width:this.GUIDE_GRAB_BUFFER*2,height:this.layout.GUIDE_GRABBER_SIZE};this.state.hoveredVerticalGuide=T(a,h)&&a.y<this.layout.POSING_AREA_HEIGHT,this.redrawPosingCanvas()}})}setupUICanvasMouseHandlers(){const{uiCanvas:t}=this.dom;t.addEventListener("mousedown",i=>{const o=A(t,i);if(T(o,this.layout.SCROLL_LEFT_BUTTON_RECT)){this.state.scrollOffset=Math.max(0,this.state.scrollOffset-1),this.updateUI();return}if(T(o,this.layout.SCROLL_RIGHT_BUTTON_RECT)){this.state.scrollOffset=Math.min(this.state.scrollOffset+1,Math.max(0,this.state.keyframes.length-this.layout.VISIBLE_THUMBNAILS)),this.updateUI();return}if(!(this.state.isAnimating&&!this.state.isPaused)){if(this.state.hoveredPlayhead){this.state.isDraggingPlayhead=!0,this.state.activeKeyframeIndex=null,this.updateUI();return}if(this.state.hoveredMarkerIndex!==null){this.state.activeKeyframeIndex!==this.state.hoveredMarkerIndex&&(S(this.state),this.state.activeKeyframeIndex=this.state.hoveredMarkerIndex,this.state.stickFigurePose=JSON.parse(JSON.stringify(this.state.keyframes[this.state.hoveredMarkerIndex].pose)),this.state.animationProgress=this.state.keyframes[this.state.hoveredMarkerIndex].time,this.state.activeKeyframeIndex<this.state.scrollOffset?this.state.scrollOffset=this.state.activeKeyframeIndex:this.state.activeKeyframeIndex>=this.state.scrollOffset+this.layout.VISIBLE_THUMBNAILS&&(this.state.scrollOffset=this.state.activeKeyframeIndex-this.layout.VISIBLE_THUMBNAILS+1)),this.state.hoveredMarkerIndex>0&&this.state.hoveredMarkerIndex<this.state.keyframes.length-1&&(this.state.draggedMarkerIndex=this.state.hoveredMarkerIndex),this.updateUI();return}if(this.state.hoveredDeleteIconIndex!==null){this.deleteKeyframe(this.state.hoveredDeleteIconIndex),this.updateUI();return}for(let n=0;n<this.layout.THUMBNAIL_RECTS.length;n++){const s=this.state.scrollOffset+n;if(T(o,this.layout.THUMBNAIL_RECTS[n])&&this.state.keyframes[s]){this.state.activeKeyframeIndex!==s&&(S(this.state),this.state.activeKeyframeIndex=s,this.state.stickFigurePose=JSON.parse(JSON.stringify(this.state.keyframes[s].pose)),this.state.animationProgress=this.state.keyframes[s].time),this.state.draggedThumbnailIndex=s,this.state.dropTargetIndex=s,this.updateUI();return}}}}),t.addEventListener("mousemove",i=>{if(this.state.isAnimating&&!this.state.isPaused)return;const o=A(t,i);this.state.currentMousePos=o;let n=!1;if(this.state.isDraggingPlayhead&&this.state.keyframes.length>0){const s=(o.x-this.layout.TIMELINE_RECT.x)/this.layout.TIMELINE_RECT.width;this.state.animationProgress=Math.max(0,Math.min(1,s)),H(this.state),this.updateUI();return}else if(this.state.draggedMarkerIndex!==null){const s=(o.x-this.layout.TIMELINE_RECT.x)/this.layout.TIMELINE_RECT.width,a=Math.max(0,Math.min(1,s)),r=this.state.keyframes[this.state.draggedMarkerIndex];let l=null,h=null;for(let u=0;u<this.state.keyframes.length;u++){if(u===this.state.draggedMarkerIndex)continue;const f=this.state.keyframes[u].time,c=r.time;f<c?(!l||f>l.time)&&(l=this.state.keyframes[u]):(!h||f<h.time)&&(h=this.state.keyframes[u])}let d=a;l&&(d=Math.max(d,l.time+.01)),h&&(d=Math.min(d,h.time-.01)),this.state.keyframes[this.state.draggedMarkerIndex].time=d,n=!0}else if(this.state.draggedThumbnailIndex!==null){let s=null;for(let a=0;a<this.layout.THUMBNAIL_RECTS.length;a++){const r=this.layout.THUMBNAIL_RECTS[a],l=this.state.scrollOffset+a;if(o.x<r.x+r.width/2){s=l;break}}s===null&&this.layout.THUMBNAIL_RECTS.length>0&&(s=this.state.scrollOffset+this.layout.THUMBNAIL_RECTS.length),s!==null&&s>=this.state.keyframes.length&&(s=this.state.keyframes.length-1),this.state.dropTargetIndex!==s&&(this.state.dropTargetIndex=s,n=!0),this.updateUI()}else{const s=this.state.hoveredPlayhead,a={x:this.layout.TIMELINE_RECT.x+this.state.animationProgress*this.layout.TIMELINE_RECT.width-5,y:this.layout.TIMELINE_RECT.y,width:10,height:this.layout.TIMELINE_RECT.height};this.state.hoveredPlayhead=T(o,a),s!==this.state.hoveredPlayhead&&(n=!0);const r=this.state.hoveredMarkerIndex;let l=null;for(let m=0;m<this.state.keyframes.length;m++){const y=R(this.state.keyframes[m],this.layout.TIMELINE_RECT);if(T(o,y)){l=m;break}}this.state.hoveredMarkerIndex=l,r!==this.state.hoveredMarkerIndex&&(n=!0);const h=this.state.hoveredThumbnailIndex;let d=null;for(let m=0;m<this.layout.THUMBNAIL_RECTS.length;m++)if(T(o,this.layout.THUMBNAIL_RECTS[m])){const y=this.state.scrollOffset+m;if(this.state.keyframes[y]){d=y;break}}this.state.hoveredThumbnailIndex=d,h!==this.state.hoveredThumbnailIndex&&(n=!0);const u=this.state.hoveredDeleteIconIndex;let f=null;for(let m=0;m<this.layout.THUMBNAIL_RECTS.length;m++){const y=this.state.scrollOffset+m;if(this.state.keyframes[y]){const g=this.getDeleteButtonRect(this.layout.THUMBNAIL_RECTS[m]);if(T(o,g)){f=y;break}}}this.state.hoveredDeleteIconIndex=f,u!==this.state.hoveredDeleteIconIndex&&(n=!0);const c=this.state.hoveredScrollLeft;this.state.hoveredScrollLeft=T(o,this.layout.SCROLL_LEFT_BUTTON_RECT),c!==this.state.hoveredScrollLeft&&(n=!0);const I=this.state.hoveredScrollRight;this.state.hoveredScrollRight=T(o,this.layout.SCROLL_RIGHT_BUTTON_RECT),I!==this.state.hoveredScrollRight&&(n=!0)}n&&this.redrawUICanvas()})}setupGlobalMouseHandlers(){const t=()=>{if(this.state.draggedPointKey&&S(this.state),this.state.isDraggingGround=!1,this.state.isDraggingVerticalGuide=!1,this.state.draggedPointKey=null,this.state.draggedEndEffector=null,this.state.isDraggingPlayhead=!1,this.state.draggedMarkerIndex!==null&&(this.state.draggedMarkerIndex=null,this.updateUI()),this.state.draggedThumbnailIndex!==null){if(this.state.dropTargetIndex!==null&&this.state.dropTargetIndex!==this.state.draggedThumbnailIndex){const i=this.state.keyframes.splice(this.state.draggedThumbnailIndex,1)[0],o=this.state.dropTargetIndex>this.state.draggedThumbnailIndex?this.state.dropTargetIndex-1:this.state.dropTargetIndex,n=this.state.keyframes[o],s=i.time;i.time=n.time,n.time=s,this.state.keyframes.splice(o,0,i),this.state.keyframes.sort((r,l)=>r.time-l.time);const a=this.state.keyframes[this.state.keyframes.length-1];if(a.time!==1){const l=this.state.animationTotalDuration*a.time;this.state.animationTotalDuration=l;for(const h of this.state.keyframes)h.time=h.time/a.time;a.time=1}this.state.activeKeyframeIndex=this.state.keyframes.indexOf(i)}this.state.draggedThumbnailIndex=null,this.state.dropTargetIndex=null,this.updateUI()}};document.addEventListener("mouseup",t)}addKeyframe(){Ie(this.state,this.layout)}deleteKeyframe(t){pe(this.state,t,this.kinematics.defaultPose,this.layout)}getDeleteButtonRect(t){return{x:t.x+t.width-18-3,y:t.y+3,width:18,height:18}}setupKeyboardHandlers(){window.addEventListener("keydown",t=>{if(!(this.state.isAnimating||document.activeElement&&document.activeElement.tagName==="INPUT"||this.state.isDraggingGround||this.state.isDraggingVerticalGuide||this.state.draggedMarkerIndex!==null)&&(t.key==="ArrowLeft"||t.key==="ArrowRight")){if(t.preventDefault(),this.state.keyframes.length===0)return;let i;this.state.activeKeyframeIndex===null?i=t.key==="ArrowLeft"?this.state.keyframes.length-1:0:i=t.key==="ArrowLeft"?this.state.activeKeyframeIndex-1:this.state.activeKeyframeIndex+1,i>=0&&i<this.state.keyframes.length&&(S(this.state),this.state.activeKeyframeIndex=i,this.state.stickFigurePose=JSON.parse(JSON.stringify(this.state.keyframes[this.state.activeKeyframeIndex].pose)),this.state.animationProgress=this.state.keyframes[this.state.activeKeyframeIndex].time,this.state.activeKeyframeIndex<this.state.scrollOffset?this.state.scrollOffset=this.state.activeKeyframeIndex:this.state.activeKeyframeIndex>=this.state.scrollOffset+this.layout.VISIBLE_THUMBNAILS&&(this.state.scrollOffset=this.state.activeKeyframeIndex-this.layout.VISIBLE_THUMBNAILS+1),this.updateUI())}})}}function Be(e,t,i,o,n,s,a){const r=new ke(e,t,n,s,a,o,i,e.posingCanvas),l=new be(e,t,i,o,n,s,a);r.setupButtonHandlers(),l.setupMouseHandlers()}const k=(e,t="0 0 24 24")=>`<svg xmlns="http://www.w3.org/2000/svg" viewBox="${t}" width="22" height="22" fill="currentColor">${e}</svg>`,E={play:k('<path d="M8 5v14l11-7z"/>'),pause:k('<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'),stop:k('<path d="M6 6h12v12H6z"/>'),insert:k('<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>'),loop:k('<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>'),pingpong:k('<path d="M8 4l-4 4 4 4V9h8v3l4-4-4-4v3H8V4zm8 13v-3h-8V9l-4 4 4 4v-3h8v3z" />'),onion:k('<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.48 0-4.5-2.02-4.5-4.5S9.52 7.5 12 7.5s4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5zm0-7C10.62 9.5 9.5 10.62 9.5 12s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5S13.38 9.5 12 9.5z"/>'),export:k('<path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>'),import:k('<path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>'),motionTrail:k('<path d="M4 6v12h2V6H4zm5 0v12h2V6H9zm5 0v12h2V6h-2z"/>'),ik:k('<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>')};function Ae(e,t){e.animateBtn.innerHTML=t.isAnimating?E.stop:E.play,e.animateBtn.title=t.isAnimating?"Stop Animation":"Animate",e.animateBtn.disabled=t.keyframes.length<2&&!t.isAnimating,e.pauseBtn.innerHTML=t.isPaused?E.play:E.pause,e.pauseBtn.title=t.isPaused?"Resume":"Pause",e.pauseBtn.disabled=!t.isAnimating,e.ikModeBtn.classList.toggle("active",t.isIKModeEnabled),e.ikModeBtn.title=t.isIKModeEnabled?"Disable IK Mode":"Enable IK Mode",e.ikModeBtn.disabled=t.isAnimating;const i=t.keyframes.some(l=>Math.abs(l.time-t.animationProgress)<1e-4),o=t.isAnimating&&t.isPaused,n=!t.isAnimating&&t.activeKeyframeIndex===null&&t.keyframes.length>=2,s=o||t.isDraggingPlayhead||n;e.insertKeyframeBtn.disabled=!s||i,e.modeBtn.innerHTML=t.animationMode==="loop"?E.loop:E.pingpong,e.modeBtn.title=`Mode: ${t.animationMode==="loop"?"Loop":"Ping-Pong"}`,e.modeBtn.disabled=t.keyframes.length<2;const a=t.isAnimating||t.activeKeyframeIndex===null;e.onionBtn.disabled=a,e.onionBtn.classList.toggle("active",t.isOnionModeEnabled&&!a),e.onionBeforeInput.disabled=a,e.onionAfterInput.disabled=a;const r=t.isAnimating;if(e.fullOnionSkinBtn.disabled=r,e.fullOnionSkinBtn.classList.toggle("active",t.isFullOnionSkinEnabled&&!r),e.motionTrailStepInput.disabled=r,e.motionTrailStepInput.value=t.motionTrailResolution.toString(),e.exportBtn.disabled=t.isAnimating||t.keyframes.length===0,e.importBtn.disabled=t.isAnimating,e.timeModeToggleBtn.disabled=t.isAnimating,e.timeModeToggleBtn.textContent=t.timeDisplayMode==="seconds"?"Use Frames":"Use Seconds",t.timeDisplayMode==="seconds")e.durationLabel.textContent="Duration (s):",e.durationInput.value=(t.animationTotalDuration/1e3).toFixed(1),e.durationInput.step="0.1",e.durationInput.min="0.1";else{const l=Math.round(t.animationTotalDuration/1e3*60);e.durationLabel.textContent="Duration (f):",e.durationInput.value=String(l),e.durationInput.step="1",e.durationInput.min="1"}e.durationInput.disabled=t.isAnimating}function Ke(){const e=J(),{posingCanvas:t,uiCanvas:i,insertKeyframeBtn:o,onionBtn:n,exportBtn:s,importBtn:a,fullOnionSkinBtn:r,ikModeBtn:l}=e;t.width=800,t.height=540;const h=t.getContext("2d");i.width=800,i.height=120;const d=i.getContext("2d");if(!h||!d)return;const u=se(i.width,i.height,t.height),f=ee(t.width,t.height),c=Y(f,u),I=W(c),m=()=>{re(h,t,I,u,f)},y=()=>{le(d,i,I,u,f)},g=()=>{Ae(e,I),m(),y(),de(t,i,I)};o.innerHTML=E.insert,n.innerHTML=E.onion,r.innerHTML=E.motionTrail,s.innerHTML=E.export,a.innerHTML=E.import,l.innerHTML=E.ik,Be(e,I,u,f,g,m,y),g()}Ke();
