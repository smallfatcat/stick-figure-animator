(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(o){if(o.ep)return;o.ep=!0;const l=i(o);fetch(o.href,l)}})();function j(){const n=document.getElementById("game-canvas"),e=document.getElementById("import-input"),i=document.getElementById("duration-input"),r=document.getElementById("duration-label"),o=document.getElementById("time-mode-toggle-btn"),l=document.getElementById("animate-btn"),a=document.getElementById("pause-btn"),d=document.getElementById("insert-keyframe-btn"),m=document.getElementById("mode-btn"),g=document.getElementById("onion-btn"),s=document.getElementById("full-onion-skin-btn"),f=document.getElementById("motion-trail-step-input"),u=document.getElementById("export-btn"),p=document.getElementById("import-btn"),I=document.getElementById("onion-before-input"),S=document.getElementById("onion-after-input");if(!n||!e||!i||!r||!o||!l||!a||!d||!m||!g||!s||!f||!u||!p||!I||!S)throw new Error("Could not find all required DOM elements.");return{canvas:n,importInput:e,durationInput:i,durationLabel:r,timeModeToggleBtn:o,animateBtn:l,pauseBtn:a,insertKeyframeBtn:d,modeBtn:m,onionBtn:g,fullOnionSkinBtn:s,motionTrailStepInput:f,exportBtn:u,importBtn:p,onionBeforeInput:I,onionAfterInput:S}}function Q(n,e){return{stickFigurePose:JSON.parse(JSON.stringify(n.defaultPose)),keyframes:[],activeKeyframeIndex:null,activeKeyframeIndexBeforeAnimation:null,groundY:e.GROUND_Y_POSITION,verticalGuideX:50,draggedPointKey:null,isDraggingGround:!1,isDraggingVerticalGuide:!1,draggedMarkerIndex:null,isDraggingPlayhead:!1,draggedThumbnailIndex:null,currentMousePos:null,hoveredThumbnailIndex:null,hoveredDeleteIconIndex:null,hoveredScrollLeft:!1,hoveredScrollRight:!1,hoveredGround:!1,hoveredVerticalGuide:!1,hoveredMarkerIndex:null,hoveredPlayhead:!1,scrollOffset:0,dropTargetIndex:null,isOnionModeEnabled:!1,onionSkinBefore:5,onionSkinAfter:5,isFullOnionSkinEnabled:!1,motionTrailResolution:1,onionTrailCanvas:null,isAnimating:!1,isPaused:!1,animationMode:"loop",animationRequestId:null,animationStartTime:null,timeElapsedBeforePause:0,animationTotalDuration:5e3,animationProgress:0,timeDisplayMode:"seconds"}}function ee(n,e,i,r,o,l,a,d){n.save(),n.strokeStyle="rgba(255, 255, 255, 0.4)",n.lineWidth=1,n.setLineDash([4,4]),n.beginPath(),n.moveTo(0,e),n.lineTo(r,e),n.stroke(),n.beginPath(),n.moveTo(i,0),n.lineTo(i,o),n.stroke(),n.setLineDash([]),n.lineCap="butt",n.lineWidth=a?8:5,n.strokeStyle=a?"rgba(255, 255, 0, 1)":"rgba(255, 255, 255, 0.6)",n.beginPath(),n.moveTo(0,e),n.lineTo(l,e),n.stroke(),n.lineWidth=d?8:5,n.strokeStyle=d?"rgba(255, 255, 0, 1)":"rgba(255, 255, 255, 0.6)",n.beginPath(),n.moveTo(i,o-l),n.lineTo(i,o),n.stroke(),n.restore()}function D(n,e,i={}){n.strokeStyle=i.strokeStyle||"#FFFFFF",n.lineWidth=3,n.lineCap="round",n.beginPath(),n.arc(e.head.x,e.head.y,20,0,Math.PI*2),n.stroke(),n.beginPath(),n.moveTo(e.head.x,e.head.y+20),n.lineTo(e.neck.x,e.neck.y),n.lineTo(e.hip.x,e.hip.y),n.stroke(),n.beginPath(),n.moveTo(e.neck.x,e.neck.y),n.lineTo(e.leftElbow.x,e.leftElbow.y),n.lineTo(e.leftHand.x,e.leftHand.y),n.moveTo(e.neck.x,e.neck.y),n.lineTo(e.rightElbow.x,e.rightElbow.y),n.lineTo(e.rightHand.x,e.rightHand.y),n.stroke(),n.fillStyle=i.fillStyle||"#FFFFFF";const r=8;n.beginPath(),n.arc(e.leftHand.x,e.leftHand.y,r,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(e.rightHand.x,e.rightHand.y,r,0,Math.PI*2),n.fill(),n.beginPath(),n.moveTo(e.hip.x,e.hip.y),n.lineTo(e.leftKnee.x,e.leftKnee.y),n.lineTo(e.leftFoot.x,e.leftFoot.y),n.moveTo(e.hip.x,e.hip.y),n.lineTo(e.rightKnee.x,e.rightKnee.y),n.lineTo(e.rightFoot.x,e.rightFoot.y),n.moveTo(e.leftFoot.x,e.leftFoot.y),n.lineTo(e.leftToe.x,e.leftToe.y),n.moveTo(e.rightFoot.x,e.rightFoot.y),n.lineTo(e.rightToe.x,e.rightToe.y),n.stroke()}function ne(n,e,i,r){if(!r)return!1;n.fillStyle="rgba(255, 255, 0, 0.3)",n.strokeStyle="rgba(255, 255, 0, 0.5)",n.lineWidth=2;let o=!1;for(const l in e){const a=e[l];Math.hypot(r.x-a.x,r.y-a.y)<i&&(n.beginPath(),n.arc(a.x,a.y,i,0,Math.PI*2),n.fill(),n.stroke(),o=!0)}return o}function F(n,e,i,r){const o={hip:{...n.hip}},l=["hip"];for(;l.length>0;){const a=l.shift(),d=o[a],m=r[a]||[];for(const g of m){const s=n.angles[g],f=i[`${g}-${a}`];s!==void 0&&f!==void 0&&(o[g]={x:d.x+Math.cos(s)*f,y:d.y+Math.sin(s)*f},l.push(g))}}return o}function ie(n,e){const i={hip:{...n.hip},angles:{}};for(const r in e){const o=e[r],l=n[r],a=n[o],d=l.x-a.x,m=l.y-a.y;i.angles[r]=Math.atan2(m,d)}return i}function oe(n,e){const i=n/2,r=e/2,o={head:{x:i,y:r-80},neck:{x:i,y:r-40},hip:{x:i,y:r+20},leftElbow:{x:i-30,y:r-20},leftHand:{x:i-60,y:r+10},rightElbow:{x:i+30,y:r-20},rightHand:{x:i+60,y:r+10},leftKnee:{x:i-20,y:r+65},leftFoot:{x:i-30,y:r+110},leftToe:{x:i-50,y:r+110},rightKnee:{x:i+20,y:r+65},rightFoot:{x:i+30,y:r+110},rightToe:{x:i+50,y:r+110}},l={neck:"hip",head:"neck",leftElbow:"neck",rightElbow:"neck",leftHand:"leftElbow",rightHand:"rightElbow",leftKnee:"hip",rightKnee:"hip",leftFoot:"leftKnee",rightFoot:"rightKnee",leftToe:"leftFoot",rightToe:"rightFoot"},a={};for(const g in l){const s=l[g];a[s]||(a[s]=[]),a[s].push(g)}const d={};for(const g in l){const s=g,f=l[s];d[`${s}-${f}`]=Math.hypot(o[s].x-o[f].x,o[s].y-o[f].y)}const m=ie(o,l);return{hierarchy:l,children:a,boneLengths:d,defaultPose:m}}function $(n){return{x:n.x+n.width-18-3,y:n.y+3,width:18,height:18}}function W(n,e){const r=e.x+n.time*e.width,o=e.y+e.height/2;return{x:r-16/2,y:o-16/2,width:16,height:16}}function re(n,e,i,r,o,l,a,d=!1){const m=l||d;n.fillStyle=m?"#444":r?"#888":"#666",n.fillRect(e.x,e.y,e.width,e.height);const g=a||d;n.fillStyle=g?"#444":o?"#888":"#666",n.fillRect(i.x,i.y,i.width,i.height),n.lineWidth=3,n.lineCap="round",n.lineJoin="round";const s=e.width*.2,f=e.height*.25;n.strokeStyle=m?"#666":"#FFF",n.beginPath(),n.moveTo(e.x+e.width/2+s,e.y+e.height/2-f),n.lineTo(e.x+e.width/2-s,e.y+e.height/2),n.lineTo(e.x+e.width/2+s,e.y+e.height/2+f),n.stroke(),n.strokeStyle=g?"#666":"#FFF",n.beginPath(),n.moveTo(i.x+i.width/2-s,i.y+i.height/2-f),n.lineTo(i.x+i.width/2+s,i.y+i.height/2),n.lineTo(i.x+i.width/2-s,i.y+i.height/2+f),n.stroke()}function le(n,e,i,r,o,l,a,d,m,g,s,f,u,p,I,S,P){if(p!==null&&u!==null){const c=p-a;if(c>=0&&c<=e.length){let b;if(c<e.length)b=e[c].x-I/2;else{const v=e[e.length-1];b=v.x+v.width+I/2}i.length>0&&e.length>0&&(n.save(),n.fillStyle="#f0ad4e",n.fillRect(b-1.5,e[0].y,3,e[0].height),n.restore())}}e.forEach((c,b)=>{const v=a+b;if(!(v>=i.length)){if(n.save(),v===u&&(n.globalAlpha=.4),n.fillStyle="#000",n.fillRect(c.x,c.y,c.width,c.height),n.strokeStyle="#555",v===o?(n.strokeStyle="#f0ad4e",n.shadowColor="#f0ad4e",n.shadowBlur=10):v===l&&!g&&(n.strokeStyle="#777"),n.lineWidth=2,n.strokeRect(c.x,c.y,c.width,c.height),n.shadowBlur=0,i[v]){const N=v===o&&o!==null?r:i[v].pose,K=F(N,s.hierarchy,s.boneLengths,s.children),M=n;M.save(),M.translate(c.x,c.y),M.scale(c.width/d,c.height/m),D(M,K),M.restore(),n.fillStyle="rgba(255, 255, 255, 0.9)",n.font="bold 12px sans-serif",n.textAlign="left",n.textBaseline="top",n.fillText(String(v+1),c.x+4,c.y+4);const G=i[v];let R="";P==="seconds"?R=`${(G.time*S/1e3).toFixed(1)}s`:R=`${Math.round(G.time*(S/1e3)*60)}f`,n.fillStyle="rgba(255, 255, 255, 0.8)",n.font="11px sans-serif",n.textAlign="right",n.textBaseline="bottom",n.fillText(R,c.x+c.width-4,c.y+c.height-4);const E=$(c),O=v===f&&!g;n.save(),n.fillStyle=O?"#e63946":"rgba(200, 50, 50, 0.8)",n.strokeStyle="#FFFFFF",n.lineWidth=1.5,n.beginPath(),n.roundRect(E.x,E.y,E.width,E.height,[4]),n.fill();const h=5;n.beginPath(),n.moveTo(E.x+h,E.y+h),n.lineTo(E.x+E.width-h,E.y+E.height-h),n.moveTo(E.x+E.width-h,E.y+h),n.lineTo(E.x+h,E.y+E.height-h),n.stroke(),n.restore()}n.restore()}})}function ae(n,e,i){const{keyframes:r,activeKeyframeIndex:o,hoveredMarkerIndex:l,isAnimating:a,animationProgress:d,isPaused:m,hoveredPlayhead:g}=i;if(n.fillStyle="#111",n.fillRect(e.x,e.y,e.width,e.height),n.strokeStyle="#555",n.lineWidth=1,n.strokeRect(e.x,e.y,e.width,e.height),r.forEach((s,f)=>{const u=W(s,e),p=f===l&&!a,I=f===o,S=f>0&&f<r.length-1;n.save(),n.translate(u.x+u.width/2,u.y+u.height/2),n.rotate(Math.PI/4);let P="#888";S||(P="#555"),I&&(P="#f0ad4e"),p&&S&&(P="#ec9b2e"),n.fillStyle=P,n.strokeStyle="#FFF",n.lineWidth=I||p?2:1,n.beginPath(),n.rect(-u.width/2,-u.height/2,u.width,u.height),n.fill(),n.stroke(),n.restore()}),r.length>0){const s=e.x+d*e.width,f=!a||m,u=f&&g;n.save(),n.strokeStyle=u?"#64faff":"#3498db",n.lineWidth=u?4:2,n.beginPath(),n.moveTo(s,e.y-4),n.lineTo(s,e.y+e.height+4),n.stroke(),f&&(n.fillStyle=u?"#64faff":"#3498db",n.beginPath(),n.arc(s,e.y+e.height/2,u?8:6,0,Math.PI*2),n.fill()),n.restore()}}function de(n,e){const r=e-180,o=396,d=r+5+65+5,m={x:50,y:d,width:n-100,height:12},g=100,s=75,f=d+m.height+5,u=10,p=5,I=40,S=p*g+(p-1)*u,P=(n-S)/2,c=Array.from({length:p},(K,M)=>({x:P+M*(g+u),y:f,width:g,height:s})),b=40,v={x:P-b-u,y:f,width:b,height:s},N={x:P+S+u,y:f,width:b,height:s};return{UI_PANEL_HEIGHT:180,POSING_AREA_HEIGHT:r,GROUND_Y_POSITION:o,TIMELINE_RECT:m,THUMBNAIL_RECTS:c,VISIBLE_THUMBNAILS:p,SCROLL_LEFT_BUTTON_RECT:v,SCROLL_RIGHT_BUTTON_RECT:N,GUIDE_GRABBER_SIZE:I,THUMBNAIL_GAP:u}}function se(n,e,i,r,o,l){const a=r.POSING_AREA_HEIGHT;n.fillStyle="#222",n.fillRect(0,a,e,r.UI_PANEL_HEIGHT),n.strokeStyle="#444",n.lineWidth=1,n.strokeRect(0,a,e,r.UI_PANEL_HEIGHT),o.keyframes.length>0&&ae(n,r.TIMELINE_RECT,o),le(n,r.THUMBNAIL_RECTS,o.keyframes,o.stickFigurePose,o.activeKeyframeIndex,o.hoveredThumbnailIndex,o.scrollOffset,e,r.POSING_AREA_HEIGHT,o.isAnimating,l,o.hoveredDeleteIconIndex,o.draggedThumbnailIndex,o.dropTargetIndex,r.THUMBNAIL_GAP,o.animationTotalDuration,o.timeDisplayMode);const d=o.scrollOffset===0,m=o.scrollOffset>=o.keyframes.length-r.VISIBLE_THUMBNAILS;re(n,r.SCROLL_LEFT_BUTTON_RECT,r.SCROLL_RIGHT_BUTTON_RECT,o.hoveredScrollLeft,o.hoveredScrollRight,d,m,o.isAnimating)}function fe(n,e,i,r,o,l){if(n.clearRect(0,0,e.width,e.height),i.activeKeyframeIndex!==null&&(n.save(),n.fillStyle="rgba(255, 255, 255, 0.7)",n.font="16px sans-serif",n.textAlign="left",n.textBaseline="top",n.fillText(`Keyframe: ${i.activeKeyframeIndex+1} / ${i.keyframes.length}`,15,15),n.restore()),ee(n,i.groundY,i.verticalGuideX,e.width,r.POSING_AREA_HEIGHT,r.GUIDE_GRABBER_SIZE,i.hoveredGround,i.hoveredVerticalGuide),i.isAnimating&&i.onionTrailCanvas&&n.drawImage(i.onionTrailCanvas,0,0),i.isOnionModeEnabled&&i.activeKeyframeIndex!==null){const g=i.activeKeyframeIndex,s=.4,f=(I,S,P)=>{var c;if(I>=0&&I<i.keyframes.length){const b=(c=i.keyframes[I])==null?void 0:c.pose;if(b&&b.hip&&b.angles){const v=s/S;if(v>.05){const N=F(b,o.hierarchy,o.boneLengths,o.children),K=`rgba(${P}, ${v})`;D(n,N,{strokeStyle:K,fillStyle:K})}}}},u="255, 87, 34",p="33, 150, 243";for(let I=1;I<=i.onionSkinBefore;I++)f(g-I,I,u);for(let I=1;I<=i.onionSkinAfter;I++)f(g+I,I,p)}const a=F(i.stickFigurePose,o.hierarchy,o.boneLengths,o.children);D(n,a);const m=!i.isAnimating&&!i.draggedMarkerIndex&&ne(n,a,15,i.currentMousePos);se(n,e.width,e.height,r,i,o),i.draggedThumbnailIndex!==null?e.style.cursor="grabbing":i.isAnimating&&!i.isPaused?e.style.cursor="default":i.isDraggingPlayhead?e.style.cursor="grabbing":i.isDraggingGround?e.style.cursor="ns-resize":i.isDraggingVerticalGuide?e.style.cursor="ew-resize":i.draggedMarkerIndex!==null?e.style.cursor="grabbing":i.hoveredThumbnailIndex!==null&&i.hoveredDeleteIconIndex===null?e.style.cursor="grab":i.hoveredPlayhead?e.style.cursor="ew-resize":i.hoveredGround?e.style.cursor="ns-resize":i.hoveredVerticalGuide?e.style.cursor="ew-resize":i.hoveredMarkerIndex!==null?e.style.cursor="grab":m||i.hoveredDeleteIconIndex!==null||i.hoveredScrollLeft||i.hoveredScrollRight?e.style.cursor="pointer":e.style.cursor="default"}function V(n,e,i){return n*(1-i)+e*i}function te(n,e,i){const r=e-n;return Math.abs(r)>Math.PI&&(r>0?n+=2*Math.PI:e+=2*Math.PI),V(n,e,i)}function me(n,e,i){const r={};for(const l in n.angles)e.angles[l]!==void 0?r[l]=te(n.angles[l],e.angles[l],i):r[l]=n.angles[l];return{hip:{x:V(n.hip.x,e.hip.x,i),y:V(n.hip.y,e.hip.y,i)},angles:r}}function X(n,e){if(e.length===0)return null;if(e.length===1)return JSON.parse(JSON.stringify(e[0].pose));let i=-1;for(let r=0;r<e.length-1;r++)if(n>=e[r].time&&n<=e[r+1].time){i=r;break}if(i===-1)return n>=1?JSON.parse(JSON.stringify(e[e.length-1].pose)):JSON.parse(JSON.stringify(e[0].pose));{const r=i+1,o=e[i],l=e[r],a=l.time-o.time,d=n-o.time,m=a===0?1:Math.min(1,d/a);return me(o.pose,l.pose,m)}}function Y(n){if(n.keyframes.length===0)return;const e=X(n.animationProgress,n.keyframes);e&&(n.stickFigurePose=e)}function he(n,e,i,r){if(!n.isFullOnionSkinEnabled||n.keyframes.length<2){n.onionTrailCanvas=null;return}const o=document.createElement("canvas");o.width=i.width,o.height=r.POSING_AREA_HEIGHT;const l=o.getContext("2d");if(!l){n.onionTrailCanvas=null;return}l.clearRect(0,0,o.width,o.height);const a=Math.floor(n.animationTotalDuration/1e3*60);if(a<2){n.onionTrailCanvas=null;return}const d=n.motionTrailResolution,m=Math.floor(a/d);if(m<=0){n.onionTrailCanvas=null;return}const s=`rgba(200, 225, 255, ${Math.max(.01,Math.min(.25,15/m))})`;for(let f=0;f<a;f+=d){const u=f/(a-1),p=X(u,n.keyframes);if(p){const I=F(p,e.hierarchy,e.boneLengths,e.children);D(l,I,{strokeStyle:s,fillStyle:s})}}n.onionTrailCanvas=o}function J(n,e,i){if(!e.isAnimating||e.animationStartTime===null||e.keyframes.length<2)return;const r=e.animationMode==="ping-pong"?e.animationTotalDuration*2:e.animationTotalDuration,o=(n-e.animationStartTime)%r;let l;e.animationMode==="ping-pong"&&o>e.animationTotalDuration?l=(e.animationTotalDuration-(o-e.animationTotalDuration))/e.animationTotalDuration:l=o/e.animationTotalDuration,e.animationProgress=l,Y(e),i(),e.isAnimating&&(e.animationRequestId=requestAnimationFrame(a=>J(a,e,i)))}function ge(n,e,i,r,o,l){n.keyframes.length<2||(he(n,r,l,o),n.isAnimating=!0,n.isPaused=!1,n.timeElapsedBeforePause=0,n.animationStartTime=performance.now(),n.activeKeyframeIndexBeforeAnimation=n.activeKeyframeIndex,n.activeKeyframeIndex=null,e(),n.animationRequestId=requestAnimationFrame(a=>J(a,n,i)))}function ue(n,e){n.animationRequestId&&cancelAnimationFrame(n.animationRequestId),n.animationRequestId=null,n.isAnimating=!1,n.isPaused=!1,n.onionTrailCanvas=null,n.activeKeyframeIndex=n.activeKeyframeIndexBeforeAnimation,n.activeKeyframeIndex!==null&&n.keyframes[n.activeKeyframeIndex]?(n.stickFigurePose=JSON.parse(JSON.stringify(n.keyframes[n.activeKeyframeIndex].pose)),n.animationProgress=n.keyframes[n.activeKeyframeIndex].time):n.keyframes.length>0?(n.activeKeyframeIndex=0,n.stickFigurePose=JSON.parse(JSON.stringify(n.keyframes[0].pose)),n.animationProgress=n.keyframes[0].time):n.animationProgress=0,e()}function ce(n,e){!n.isAnimating||n.isPaused||(n.animationRequestId&&cancelAnimationFrame(n.animationRequestId),n.animationRequestId=null,n.isPaused=!0,n.animationStartTime&&(n.timeElapsedBeforePause=performance.now()-n.animationStartTime),e())}function ye(n,e,i){!n.isAnimating||!n.isPaused||(n.isPaused=!1,n.animationStartTime&&(n.animationStartTime=performance.now()-n.timeElapsedBeforePause),e(),n.animationRequestId=requestAnimationFrame(r=>J(r,n,i)))}function Z(n){const e=n.length;if(!(e<1)){if(e===1){n[0].time=0;return}n.forEach((i,r)=>{i.time=r/(e-1)})}}function H(n){n.activeKeyframeIndex!==null&&n.keyframes[n.activeKeyframeIndex]&&(n.keyframes[n.activeKeyframeIndex].pose=JSON.parse(JSON.stringify(n.stickFigurePose)))}function Ie(n,e){H(n);const i={pose:JSON.parse(JSON.stringify(n.stickFigurePose)),time:0},r=n.activeKeyframeIndex===null?n.keyframes.length:n.activeKeyframeIndex+1;let o;if(n.keyframes.length===0)o=0;else{const a=r<n.keyframes.length?n.keyframes[r]:null;if(a){const d=n.keyframes[r-1];o=d.time+(a.time-d.time)/2}else{const d=n.keyframes[n.keyframes.length-1],m=n.animationTotalDuration,f=d.time*m+1e3;if(n.animationTotalDuration=f,f>0)for(const u of n.keyframes)u.time=u.time*m/f;o=1}}i.time=o,n.keyframes.splice(r,0,i),n.activeKeyframeIndex=r,n.animationProgress=o;const l=n.activeKeyframeIndex;l!==null&&(l<n.scrollOffset?n.scrollOffset=l:l>=n.scrollOffset+e.VISIBLE_THUMBNAILS&&(n.scrollOffset=l-e.VISIBLE_THUMBNAILS+1))}function Te(n,e,i,r){H(n),n.activeKeyframeIndex===e&&(n.activeKeyframeIndex=null,n.stickFigurePose=JSON.parse(JSON.stringify(i)),n.animationProgress=0,n.isOnionModeEnabled=!1),n.keyframes.splice(e,1),n.activeKeyframeIndex!==null&&n.activeKeyframeIndex>e&&n.activeKeyframeIndex--,Z(n.keyframes),n.hoveredDeleteIconIndex=null,n.scrollOffset=Math.max(0,Math.min(n.scrollOffset,n.keyframes.length-r.VISIBLE_THUMBNAILS))}function pe(n,e,i){const r={pose:JSON.parse(JSON.stringify(e)),time:i};return n.keyframes.push(r),n.keyframes.sort((o,l)=>o.time-l.time),n.keyframes.indexOf(r)}function z(n,e){const i=n.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}}function A(n,e){return n.x>e.x&&n.x<e.x+e.width&&n.y>e.y&&n.y<e.y+e.height}function ve(n){if(n.length===0){console.warn("No keyframes to export.");return}const e=JSON.stringify(n,null,2),i=new Blob([e],{type:"application/json"}),r=URL.createObjectURL(i),o=document.createElement("a");o.href=r,o.download="stick-figure-animation.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}function q(n){return n.angles&&n.angles.leftToe===void 0&&(n.angles.leftToe=Math.PI),n.angles&&n.angles.rightToe===void 0&&(n.angles.rightToe=0),n}function Ee(n){return new Promise((e,i)=>{const r=new FileReader;r.onload=o=>{var l;try{const a=(l=o.target)==null?void 0:l.result;if(typeof a!="string")throw new Error("Failed to read file.");const d=JSON.parse(a);if(!Array.isArray(d))throw new Error("Invalid keyframe file: not an array.");if(d.length===0){e([]);return}if(d[0].pose!==void 0&&typeof d[0].time=="number"){const m=d.map(g=>({...g,pose:q(g.pose)}));if(m.some(g=>{var s,f,u;return typeof((f=(s=g.pose)==null?void 0:s.hip)==null?void 0:f.x)!="number"||typeof((u=g.pose)==null?void 0:u.angles)!="object"}))throw new Error("Invalid keyframe file format.");e(m)}else if(d[0].hip!==void 0&&d[0].angles!==void 0){const m=d.length,g=d.map((s,f)=>({pose:q(s),time:m<=1?0:f/(m-1)}));e(g)}else throw new Error("Unrecognized keyframe file format.")}catch(a){console.error("Error loading keyframes:",a),i(a)}},r.onerror=()=>{i(new Error("Error reading file."))},r.readAsText(n)})}function Se(n,e,i,r,o,l){const{canvas:a,animateBtn:d,pauseBtn:m,modeBtn:g,onionBtn:s,exportBtn:f,importBtn:u,importInput:p,durationInput:I,onionBeforeInput:S,onionAfterInput:P,insertKeyframeBtn:c,timeModeToggleBtn:b,fullOnionSkinBtn:v,motionTrailStepInput:N}=n,{defaultPose:K,hierarchy:M,boneLengths:G,children:R}=r,E=15,O=10;d.addEventListener("click",()=>{e.isAnimating?ue(e,o):e.keyframes.length>=2&&(H(e),ge(e,o,l,r,i,a))}),m.addEventListener("click",()=>{e.isAnimating&&(e.isPaused?ye(e,o,l):ce(e,o))}),c.addEventListener("click",()=>{if(c.disabled)return;const h=pe(e,e.stickFigurePose,e.animationProgress);e.animationRequestId&&cancelAnimationFrame(e.animationRequestId),e.animationRequestId=null,e.isAnimating=!1,e.isPaused=!1,e.activeKeyframeIndex=h,e.activeKeyframeIndex<e.scrollOffset?e.scrollOffset=e.activeKeyframeIndex:e.activeKeyframeIndex>=e.scrollOffset+i.VISIBLE_THUMBNAILS&&(e.scrollOffset=e.activeKeyframeIndex-i.VISIBLE_THUMBNAILS+1),o()}),g.addEventListener("click",()=>{e.keyframes.length<2||(e.animationMode=e.animationMode==="loop"?"ping-pong":"loop",o())}),s.addEventListener("click",()=>{e.isAnimating||e.activeKeyframeIndex===null||(e.isOnionModeEnabled=!e.isOnionModeEnabled,o())}),v.addEventListener("click",()=>{v.disabled||(e.isFullOnionSkinEnabled=!e.isFullOnionSkinEnabled,o())}),N.addEventListener("change",()=>{const h=parseInt(N.value,10);!isNaN(h)&&h>=1?e.motionTrailResolution=h:N.value=e.motionTrailResolution.toString()}),S.addEventListener("change",()=>{const h=parseInt(S.value,10);!isNaN(h)&&h>=0?(e.onionSkinBefore=h,e.isOnionModeEnabled&&o()):S.value=e.onionSkinBefore.toString()}),P.addEventListener("change",()=>{const h=parseInt(P.value,10);!isNaN(h)&&h>=0?(e.onionSkinAfter=h,e.isOnionModeEnabled&&o()):P.value=e.onionSkinAfter.toString()}),f.addEventListener("click",()=>{e.isAnimating||e.keyframes.length===0||(H(e),ve(e.keyframes))}),u.addEventListener("click",()=>{e.isAnimating||p.click()}),p.addEventListener("change",async h=>{var y;const t=(y=h.target.files)==null?void 0:y[0];if(t)try{H(e);const T=await Ee(t);e.keyframes=T,e.scrollOffset=0,e.keyframes.length>0?(e.activeKeyframeIndex=0,e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[0].pose)),e.animationProgress=e.keyframes[0].time):(e.activeKeyframeIndex=null,e.stickFigurePose=JSON.parse(JSON.stringify(K)),e.animationProgress=0),e.isOnionModeEnabled=!1,o()}catch{alert("Failed to load keyframes. Please check the file format.")}h.target.value=""}),b.addEventListener("click",()=>{e.isAnimating||(e.timeDisplayMode=e.timeDisplayMode==="seconds"?"frames":"seconds",o())}),I.addEventListener("change",()=>{if(e.timeDisplayMode==="seconds"){const h=parseFloat(I.value);!isNaN(h)&&h>0?e.animationTotalDuration=h*1e3:alert("Invalid duration. Please enter a positive number.")}else{const h=parseInt(I.value,10);!isNaN(h)&&h>0?e.animationTotalDuration=h/60*1e3:alert("Invalid duration. Please enter a positive integer for frames.")}o()}),a.addEventListener("mousedown",h=>{const t=z(a,h);if(e.isAnimating&&!e.isPaused)return;if(e.hoveredPlayhead){e.isDraggingPlayhead=!0,e.activeKeyframeIndex=null,o();return}if(e.hoveredMarkerIndex!==null){e.activeKeyframeIndex!==e.hoveredMarkerIndex&&(H(e),e.activeKeyframeIndex=e.hoveredMarkerIndex,e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[e.hoveredMarkerIndex].pose)),e.animationProgress=e.keyframes[e.hoveredMarkerIndex].time,e.activeKeyframeIndex<e.scrollOffset?e.scrollOffset=e.activeKeyframeIndex:e.activeKeyframeIndex>=e.scrollOffset+i.VISIBLE_THUMBNAILS&&(e.scrollOffset=e.activeKeyframeIndex-i.VISIBLE_THUMBNAILS+1)),e.hoveredMarkerIndex>0&&e.hoveredMarkerIndex<e.keyframes.length-1&&(e.draggedMarkerIndex=e.hoveredMarkerIndex),o();return}const y={x:0,y:e.groundY-O,width:i.GUIDE_GRABBER_SIZE,height:O*2};if(A(t,y)&&t.y<i.POSING_AREA_HEIGHT){e.isDraggingGround=!0;return}const T={x:e.verticalGuideX-O,y:i.POSING_AREA_HEIGHT-i.GUIDE_GRABBER_SIZE,width:O*2,height:i.GUIDE_GRABBER_SIZE};if(A(t,T)&&t.y<i.POSING_AREA_HEIGHT){e.isDraggingVerticalGuide=!0;return}if(e.hoveredDeleteIconIndex!==null){Te(e,e.hoveredDeleteIconIndex,K,i),o();return}if(A(t,i.SCROLL_LEFT_BUTTON_RECT)){e.scrollOffset=Math.max(0,e.scrollOffset-1),o();return}if(A(t,i.SCROLL_RIGHT_BUTTON_RECT)){e.scrollOffset=Math.min(e.scrollOffset+1,Math.max(0,e.keyframes.length-i.VISIBLE_THUMBNAILS)),o();return}for(let x=0;x<i.THUMBNAIL_RECTS.length;x++){const _=e.scrollOffset+x;if(A(t,i.THUMBNAIL_RECTS[x])&&e.keyframes[_]){e.activeKeyframeIndex!==_&&(H(e),e.activeKeyframeIndex=_,e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[_].pose)),e.animationProgress=e.keyframes[_].time),e.draggedThumbnailIndex=_,o();return}}const k=F(e.stickFigurePose,M,G,R);let L=null,U=1/0;for(const x in k){const _=x,C=Math.hypot(t.x-k[_].x,t.y-k[_].y);C<E&&C<U&&(U=C,L=_)}e.draggedPointKey=L,!e.draggedPointKey&&t.y<i.POSING_AREA_HEIGHT&&(Ie(e,i),o())}),a.addEventListener("mousemove",h=>{const t=z(a,h);if(e.currentMousePos=t,e.draggedThumbnailIndex!==null){e.dropTargetIndex=null;for(let y=0;y<i.THUMBNAIL_RECTS.length;y++){const T=i.THUMBNAIL_RECTS[y],k=e.scrollOffset+y;if(!(k>=e.keyframes.length)&&A(t,T)){if(k===e.draggedThumbnailIndex)e.dropTargetIndex=null;else{const L=T.x+T.width/2;e.dropTargetIndex=t.x<L?k:k+1}break}}o();return}if(e.isDraggingPlayhead){const y=i.TIMELINE_RECT;let T=(t.x-y.x)/y.width;T=Math.max(0,Math.min(1,T)),e.animationProgress=T,e.timeElapsedBeforePause=e.animationProgress*e.animationTotalDuration,Y(e),o();return}if(e.draggedMarkerIndex!==null){const y=i.TIMELINE_RECT;let T=(t.x-y.x)/y.width;const k=e.keyframes[e.draggedMarkerIndex-1].time,L=e.keyframes[e.draggedMarkerIndex+1].time;T=Math.max(k,Math.min(T,L)),e.keyframes[e.draggedMarkerIndex].time=T,o();return}if(e.isDraggingGround){e.groundY=Math.max(0,Math.min(t.y,i.POSING_AREA_HEIGHT)),o();return}if(e.isDraggingVerticalGuide){e.verticalGuideX=Math.max(0,Math.min(t.x,a.width)),o();return}if(e.hoveredScrollLeft=!1,e.hoveredScrollRight=!1,e.hoveredThumbnailIndex=null,e.hoveredDeleteIconIndex=null,e.hoveredMarkerIndex=null,e.hoveredGround=!1,e.hoveredVerticalGuide=!1,e.hoveredPlayhead=!1,!e.isAnimating||e.isPaused){if(e.keyframes.length>0){const T={x:i.TIMELINE_RECT.x+e.animationProgress*i.TIMELINE_RECT.width-6,y:i.TIMELINE_RECT.y-6,width:12,height:i.TIMELINE_RECT.height+12};A(t,T)&&(e.hoveredPlayhead=!0)}e.hoveredScrollLeft=A(t,i.SCROLL_LEFT_BUTTON_RECT),e.hoveredScrollRight=A(t,i.SCROLL_RIGHT_BUTTON_RECT);for(let y=0;y<e.keyframes.length;y++){const T=W(e.keyframes[y],i.TIMELINE_RECT);if(A(t,T)){e.hoveredMarkerIndex=y;break}}if(t.y<i.POSING_AREA_HEIGHT){const y={x:0,y:e.groundY-O,width:i.GUIDE_GRABBER_SIZE,height:O*2},T={x:e.verticalGuideX-O,y:i.POSING_AREA_HEIGHT-i.GUIDE_GRABBER_SIZE,width:O*2,height:i.GUIDE_GRABBER_SIZE};A(t,y)?e.hoveredGround=!0:A(t,T)&&(e.hoveredVerticalGuide=!0)}for(let y=0;y<i.THUMBNAIL_RECTS.length;y++){const T=i.THUMBNAIL_RECTS[y],k=e.scrollOffset+y;if(e.keyframes[k]&&A(t,T)){e.hoveredThumbnailIndex=k;const L=$(T);if(A(t,L)){e.hoveredDeleteIconIndex=k,e.hoveredThumbnailIndex=null;break}}}}if(e.draggedPointKey)if(t.y=Math.min(t.y,i.POSING_AREA_HEIGHT-2),e.draggedPointKey==="hip")e.stickFigurePose.hip=t;else{const y=M[e.draggedPointKey],k=F(e.stickFigurePose,M,G,R)[y],L=Math.atan2(t.y-k.y,t.x-k.x);e.stickFigurePose.angles[e.draggedPointKey]=L}o()}),a.addEventListener("mouseup",()=>{if(e.draggedThumbnailIndex!==null&&e.dropTargetIndex!==null){const h=e.draggedThumbnailIndex;let t=e.dropTargetIndex;const[y]=e.keyframes.splice(h,1);h<t&&t--,e.keyframes.splice(t,0,y),e.activeKeyframeIndex=t,Z(e.keyframes),e.keyframes[t]&&(e.animationProgress=e.keyframes[t].time)}e.draggedPointKey=null,e.isDraggingGround=!1,e.isDraggingVerticalGuide=!1,e.draggedMarkerIndex=null,e.isDraggingPlayhead=!1,e.draggedThumbnailIndex=null,e.dropTargetIndex=null,o()}),a.addEventListener("mouseleave",()=>{e.draggedPointKey=null,e.isDraggingGround=!1,e.isDraggingVerticalGuide=!1,e.draggedMarkerIndex=null,e.isDraggingPlayhead=!1,e.draggedThumbnailIndex=null,e.dropTargetIndex=null,e.currentMousePos=null,(!e.isAnimating||e.isPaused)&&(e.hoveredScrollLeft=!1,e.hoveredScrollRight=!1,e.hoveredThumbnailIndex=null,e.hoveredDeleteIconIndex=null,e.hoveredGround=!1,e.hoveredVerticalGuide=!1,e.hoveredMarkerIndex=null,e.hoveredPlayhead=!1),o()}),window.addEventListener("keydown",h=>{if(!(e.isAnimating||document.activeElement&&document.activeElement.tagName==="INPUT"||e.isDraggingGround||e.isDraggingVerticalGuide||e.draggedMarkerIndex!==null)&&(h.key==="ArrowLeft"||h.key==="ArrowRight")){if(h.preventDefault(),e.keyframes.length===0)return;let t;e.activeKeyframeIndex===null?t=h.key==="ArrowLeft"?e.keyframes.length-1:0:t=h.key==="ArrowLeft"?e.activeKeyframeIndex-1:e.activeKeyframeIndex+1,t>=0&&t<e.keyframes.length&&(H(e),e.activeKeyframeIndex=t,e.stickFigurePose=JSON.parse(JSON.stringify(e.keyframes[e.activeKeyframeIndex].pose)),e.animationProgress=e.keyframes[e.activeKeyframeIndex].time,e.activeKeyframeIndex<e.scrollOffset?e.scrollOffset=e.activeKeyframeIndex:e.activeKeyframeIndex>=e.scrollOffset+i.VISIBLE_THUMBNAILS&&(e.scrollOffset=e.activeKeyframeIndex-i.VISIBLE_THUMBNAILS+1),o())}})}const w=(n,e="0 0 24 24")=>`<svg xmlns="http://www.w3.org/2000/svg" viewBox="${e}" width="22" height="22" fill="currentColor">${n}</svg>`,B={play:w('<path d="M8 5v14l11-7z"/>'),pause:w('<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'),stop:w('<path d="M6 6h12v12H6z"/>'),insert:w('<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>'),loop:w('<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>'),pingpong:w('<path d="M8 4l-4 4 4 4V9h8v3l4-4-4-4v3H8V4zm8 13v-3h-8V9l-4 4 4 4v-3h8v3z" />'),onion:w('<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.48 0-4.5-2.02-4.5-4.5S9.52 7.5 12 7.5s4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5zm0-7C10.62 9.5 9.5 10.62 9.5 12s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5S13.38 9.5 12 9.5z"/>'),export:w('<path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>'),import:w('<path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>'),motionTrail:w('<path d="M4 6v12h2V6H4zm5 0v12h2V6H9zm5 0v12h2V6h-2z"/>')};function ke(n,e){n.animateBtn.innerHTML=e.isAnimating?B.stop:B.play,n.animateBtn.title=e.isAnimating?"Stop Animation":"Animate",n.animateBtn.disabled=e.keyframes.length<2&&!e.isAnimating,n.pauseBtn.innerHTML=e.isPaused?B.play:B.pause,n.pauseBtn.title=e.isPaused?"Resume":"Pause",n.pauseBtn.disabled=!e.isAnimating;const i=e.keyframes.some(m=>Math.abs(m.time-e.animationProgress)<1e-4),r=e.isAnimating&&e.isPaused,o=!e.isAnimating&&e.activeKeyframeIndex===null&&e.keyframes.length>=2,l=r||e.isDraggingPlayhead||o;n.insertKeyframeBtn.disabled=!l||i,n.modeBtn.innerHTML=e.animationMode==="loop"?B.loop:B.pingpong,n.modeBtn.title=`Mode: ${e.animationMode==="loop"?"Loop":"Ping-Pong"}`,n.modeBtn.disabled=e.keyframes.length<2;const a=e.isAnimating||e.activeKeyframeIndex===null;n.onionBtn.disabled=a,n.onionBtn.classList.toggle("active",e.isOnionModeEnabled&&!a),n.onionBeforeInput.disabled=a,n.onionAfterInput.disabled=a;const d=e.isAnimating;if(n.fullOnionSkinBtn.disabled=d,n.fullOnionSkinBtn.classList.toggle("active",e.isFullOnionSkinEnabled&&!d),n.motionTrailStepInput.disabled=d,n.motionTrailStepInput.value=e.motionTrailResolution.toString(),n.exportBtn.disabled=e.isAnimating||e.keyframes.length===0,n.importBtn.disabled=e.isAnimating,n.timeModeToggleBtn.disabled=e.isAnimating,n.timeModeToggleBtn.textContent=e.timeDisplayMode==="seconds"?"Use Frames":"Use Seconds",e.timeDisplayMode==="seconds")n.durationLabel.textContent="Duration (s):",n.durationInput.value=(e.animationTotalDuration/1e3).toFixed(1),n.durationInput.step="0.1",n.durationInput.min="0.1";else{const m=Math.round(e.animationTotalDuration/1e3*60);n.durationLabel.textContent="Duration (f):",n.durationInput.value=String(m),n.durationInput.step="1",n.durationInput.min="1"}n.durationInput.disabled=e.isAnimating}function Pe(){const n=j(),{canvas:e,insertKeyframeBtn:i,onionBtn:r,exportBtn:o,importBtn:l,fullOnionSkinBtn:a}=n;e.width=800,e.height=720;const d=e.getContext("2d");if(!d)return;const m=de(e.width,e.height),g=oe(e.width,m.POSING_AREA_HEIGHT),s=Q(g,m),f=()=>fe(d,e,s,m,g),u=()=>{ke(n,s),f()};i.innerHTML=B.insert,r.innerHTML=B.onion,a.innerHTML=B.motionTrail,o.innerHTML=B.export,l.innerHTML=B.import,Se(n,s,m,g,u,f),u()}Pe();
